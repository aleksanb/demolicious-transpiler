<!DOCTYPE html>
<html>
  <head>
    <title>
      Demolicious Simulator 3000
    </title>
    <script src=transpiler.js></script>
  </head>
  <body>

    <style>
      
      body, html {
        background: #111; 
      }
      canvas {
        position: fixed; 
        left: 20px;
        top: 50%;
        margin-top: -128px;
      }
      #edit-area {
        display: block;
        margin-left: 552px;
        width: 512px;
        font-size: 16px;
        white-space: pre;
        font-family: monospace;
        color: #0f0;
        outline: 0;
      }
    </style>
    <canvas id=c></canvas>
    <div contentEditable id=edit-area>
mv $address_lo, $id_lo
mv $address_hi, $id_hi


; if x * x + y * y &lt; 100

; $7 = x
; $8 = y
; $13 = 128

sra $12, $15, 4

ldi $data, 0x18C3

ldi $13, 128
ldi $14, 511
and $7, $id_lo, $14
sub $7, $7, $13
sub $7, $7, $13
sra $8, $id_lo, 9
sll $14, $id_hi, 7
add $8, $8, $14
sub $8, $8, $13

ldi $12, 5000
mul $9, $7, $7
mul $10, $8, $8
add $11, $9, $10
slt $mask, $12, $11
? addi $data, $data 0xE000 ; red

ldi $12, 3500
ldi $14, 511
and $7, $id_lo, $14
sra $10, $15, 3
add $7, $7, $10
and $7, $7, $14
sub $7, $7, $13
sub $7, $7, $13
sub $7, $7, $13
mul $9, $7, $7
mul $10, $8, $8
add $11, $9, $10
slt $mask, $12, $11
? addi $data, $data, 0x0720 ; green

ldi $12, 2000
ldi $14, 511
and $7, $id_lo, $14
sra $10, $15, 2
sub $7, $7, $10
and $7, $7, $14
sub $7, $7, $13
mul $9, $7, $7
mul $10, $8, $8
add $11, $9, $10
slt $mask, $12, $11
? addi $data, $data, 0x001C; blue
sw
    </div>

    <script>
      var gl;
      var canvas;
      var buffer;

    window.addEventListener('load', init);

    function init() {
      canvas = document.getElementById('c');
      gl = canvas.getContext('experimental-webgl');
      canvas.width = 512;
      canvas.height = 256;

      var compileDebounce;
      document.querySelector('#edit-area').addEventListener('keyup', function() {
        clearTimeout(compileDebounce);
        setTimeout(function() {
        compile(transpiler.transpile(
          document.querySelector('#edit-area').innerText,
          document.querySelector('#preamble').text,
          document.querySelector('#postamble').text));
        }, 100);
      });

      gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
      buffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
      gl.bufferData(
      gl.ARRAY_BUFFER, 
      new Float32Array([
      -1.0, -1.0, 
      1.0, -1.0, 
      -1.0, 1.0, 
      -1.0, 1.0, 
      1.0, -1.0, 
      1.0, 1.0]), 
      gl.STATIC_DRAW
      );

        compile(transpiler.transpile(
        document.querySelector('#edit-area').innerHTML,
        document.querySelector('#preamble').text,
        document.querySelector('#postamble').text));
      render();

    }


    function compile(fragmentShaderSource) {
      var shaderScript = document.getElementById("vertex-shader");
      var shaderSource = shaderScript.text;
      var vertexShader = gl.createShader(gl.VERTEX_SHADER);
      gl.shaderSource(vertexShader, shaderSource);
      gl.compileShader(vertexShader);
      var compiled = gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS);
      console.log('Shader compiled successfully: ' + compiled);
      var compilationLog = gl.getShaderInfoLog(vertexShader);
      console.log('Shader compiler log: ' + compilationLog);
      var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
      gl.shaderSource(fragmentShader, fragmentShaderSource);
      gl.compileShader(fragmentShader);
      var compiled = gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS);
      console.log('Shader compiled successfully: ' + compiled);
      var compilationLog = gl.getShaderInfoLog(fragmentShader);
      console.log('Shader compiler log: ' + compilationLog);
      var program = gl.createProgram();
      gl.attachShader(program, vertexShader);
      gl.attachShader(program, fragmentShader);
      gl.linkProgram(program); 
      gl.useProgram(program);
      gl.program = program;
    }

    var time = 0;
    function render() {
      time += 1 / 60;
      window.requestAnimationFrame(render, canvas);
      gl.uniform1f(gl.getUniformLocation(gl.program, 'iGlobalTime'), time);
      var positionLocation = gl.getAttribLocation(gl.program, "a_position");
      gl.enableVertexAttribArray(positionLocation);
      gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
      gl.clearColor(1.0, 0.0, 0.0, 1.0);
      gl.clear(gl.COLOR_BUFFER_BIT);
      gl.drawArrays(gl.TRIANGLES, 0, 6);
    }
  </script>

  <script id=vertex-shader type=x-shader/x-vertex>
    precision highp float;
    precision highp int;
    attribute vec2 a_position;
    void main() {
      gl_Position = vec4(a_position, 0, 1);
    }
  </script>


  <script id=fragment-shader type=x-shader/x-fragment>
    void main() {
      gl_FragColor = vec4(gl_FragCoord.x / 640.0, gl_FragCoord.y / 480.0, 0, 1);
    }
  </script>

  <script id=preamble type=x-shader/x-fragment-partial>
    precision highp float;
    precision highp int;
    uniform float iGlobalTime;
int xor(int a, int b) {
    int result = 0;
    for(int i = 0; i < 16; i++) {
        if(mod(float(a), 2.) > .5) {
            if(mod(float(b), 2.) < .5) {
                result += int(pow(2., float(i)));
            }
        }
        else if(mod(float(a), 2.) < .5) {
            if(mod(float(b), 2.) > .5) {
                result += int(pow(2., float(i)));
            }
        }
        a /= 2;
        b /= 2;
    }
    return result;
}

int and(int a, int b) {
    int result = 0;
    for(int i = 0; i < 16; i++) {
        if(mod(float(a), 2.) > .5) {
            if(mod(float(b), 2.) > .5) {
                result += int(pow(2., float(i)));
            }
        }
        a /= 2;
        b /= 2;
    }
    return result;
}

int or(int a, int b) {
    int result = 0;
    for(int i = 0; i < 16; i++) {
        if(mod(float(a), 2.) > .5 || mod(float(b), 2.) > .5) {
            result += int(pow(2., float(i)));
        }
        a /= 2;
        b /= 2;
    }
    return result;
}

vec3 color(int data) {
    vec3 color = vec3(0., 0., 0.);
    color.r = float(and(data, 63488) / int(pow(2., 11.)));
    color.g = float(and(data, 2016) / int(pow(2., 5.)));
    color.b = float(and(data, 31));
    color.r *= pow(2., 3.);
    color.g *= pow(2., 2.);
    color.b *= pow(2., 3.);
    color /= 256.;
    return color;
}

#define sra(a, b) (a / int(pow(2., float(b))))
#define srl(a, b) (a / int(pow(2., float(b))))
#define sll(a, b) (a *   int(pow(2., float(b))))


#define address_lo 4
#define address_hi 3
#define id_hi 1
#define id_lo 2
#define mask 6
#define data 5


void main(void)
{
    
    vec2 uv = gl_FragCoord.xy / vec2(512., 256.);
    uv.x *= 512.;
    uv.y = 256. - uv.y * 256.;
   
    
    int r[16];
    r[0] = 0;
    r[1] = ((int(uv.y) * 512 + int(uv.x)) / 0xFFFF);
    r[2] = and(int(uv.y) * 512 + int(uv.x), 0xFFFF);
    r[3] = 0;
    r[4] = 0;
    r[5] = 0;
    r[6] = 0;
    r[7] = 0;
    r[8] = 0;
    r[9] = 0;
    r[10] = 0;
    r[11] = 0;
    r[12] = 0;
    r[13] = 0;
    r[14] = 0;
    r[15] = int(iGlobalTime * 1000.);
  </script>
  <script id=postamble type=x-shader/x-fragment-partial>
}
  </script>
</body>
</html>
